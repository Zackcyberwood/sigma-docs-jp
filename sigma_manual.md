データモデリングを始める
データモデルは、生データを変更することなく、構造化されたガバナンスに基づいてデータを整理・格納するためのセマンティックレイヤー（意味的な階層）を提供します。最も重要なのは、データモデルが再利用可能であるという点です。データモデルを作成することで、ビジネスロジックとメトリクス（指標）を一元管理し、結合や長い数式の記述といった繰り返し作業を最小限に抑えることができます。

再利用可能なデータソース要素を使用してデータモデルを構築します。

分析の都度カスタム結合を構築する代わりに、関連するデータソース間のリレーションシップ（関係）を定義します。

集計分析の一貫性を向上させるためのメトリクスを定義します。

データモデルは、データの操作を容易にし、分析結果に対するユーザーの信頼性を高めます。Sigmaでデータを操作するためにデータモデルが必須なわけではありません。しかし、データモデルを利用することで、ビジネスユーザーは、専門家によって管理（キュレーション）され、信頼性が確保されたデータを使い、安心して分析や探索を行うことができます。

データモデルとは
データモデルはSigmaドキュメントの一種であり、再利用可能なデータソース要素のコレクションを作成・整理するためのフレームワークを提供します。データ管理者（キュレーター）は、接続されたプラットフォームから読み込んだデータをデータモデルとして整備し、組織のユーザーがワークブックや他のデータモデルのソースとして利用できるようにします。

データモデルは、関連データを統合、拡張、共有するための包括的で動的なプラットフォームです。組織のメンバーはこれらのデータをワークブックや他のデータモデルで再利用できます。単一のデータモデルは、より広範なデータコンテキストにおける様々なサブセット、視点、評価を提供する、再利用可能な要素のコレクションを格納するコンテナとして機能します。この階層的なデータ表現は、関連性が高く詳細なワークブック分析を構築するための、便利で構造化された基盤となります。

データモデルには次のような利点もあります。

一元管理された権限 (Centralized permissions)
データモデルのレベルで権限を付与することで、一貫性のある合理化されたアクセス制御を実現します。

効率的なデータ処理 (Efficient data processing)
コントロール（入力欄など）を使用して再利用可能な要素を強化し、データセグメントを簡単にフィルター処理および調整します。

柔軟な再利用性 (Flexible reusability)
データソースとして再利用するための要素を、迅速に有効化または無効化します。

適切に設計されたデータモデルを使用することで、ユーザーは分析に必要なデータに簡単にアクセスできるようになり、データ分析に要する時間と労力を削減できます。

データモデルとデータセットの違い
データモデルは、データセットとほぼ同様の機能をサポートしています（あるいは、将来的にサポートする予定です）。

メトリクス (Metrics)

リレーションシップ (Relationships)

列レベルのセキュリティ (Column-Level Security)

行レベルのセキュリティ (Row-Level Security)

階層 (Hierarchies)

マテリアライゼーション（実体化）(Materialization)

パラメータ (Parameters)




メトリクスについて (About metrics)
メトリクスとは、データソースに固有の、動的で再利用可能な計算式のことです。通常、メトリクスは特定の列を参照して作成されます。複雑な数式をビジネスユーザーから見えなくし、信頼性が高く効率的な集計計算を提供するためにメティクスを作成することができます。

メトリクスは、組織全体で一貫性のある正確な計算を保証するのに役立ちます。
（補足：もし特定のデータ型を持つ任意の列を引数として受け取る再利用可能な計算を作りたい場合は、代わりにカスタム関数を作成します。）

メトリクスと計算列の使い分け
メトリクスと計算列は似ていますが、重要な違いがあります。

メトリクス (Metrics)
データソースに固有の、動的で再利用可能な集計計算です。メトリクスは、あらゆるグルーピングレベルで集計された値を提供します。例えば、「合計売上」というメトリクスを作れば、日別、月別、店舗別など、様々な切り口で合計売上を瞬時に計算できます。

計算列 (Calculated Columns)
作成されたデータ要素に固有の、静的な行レベルの計算です。各行に対して個別に計算結果を返します。例えば、「単価 * 数量」という計算列を作ると、表の各行にその行だけの「売上」が計算されます。

もし計算列を使って「利益率」などを複数のワークブックで計算している場合、後から計算式を修正する必要が出たら、その計算列を使っている全ての要素で修正作業を行わなければなりません。
メトリクスを使っていれば、データソース側でメトリクスの計算式を一度更新するだけで、そのメトリクスを使用している全ての要素の計算結果が自動的に再計算されます。

制限事項
メトリクスは、Join（結合）や Union（統合）をまたいで伝播することはありません。また、全てのソース列ではなくグルーピングレベルに基づいた子要素にも伝播しません。

メトリクスは単一のデータソース内でのみ定義できます。組織全体や複数のデータソースで同じロジックを適用したい場合は、該当する各データモデルやデータセットでそれぞれメトリクスを定義する必要があります。

メトリクスの数式では、ウィンドウ関数や結合関数はサポートされていません。

URLパラメータ (URL Parameters)



リレーションシップを定義する (Define relationships in data models)
データモデル内でテーブル間のリレーションシップ（関係）を追加することで、ビジネスユーザーは、その都度手動で結合（Join）を行うことなく、関連するデータを扱えるようになります。リレーションシップは、Sigmaがテーブルを結合する際に使用する結合ロジックをあらかじめ定義するものです。

2つのテーブル間にリレーションシップを定義すると、両方のテーブルの列が、分析や探索のためにソーステーブル（親となるテーブル）で利用可能になります。ユーザーがワークブックでソーステーブルを分析し、関連する列を追加すると、Sigmaが裏側で定義されたロジックに従って結合を実行します。

リレーションシップは、不要な結合を減らし、クエリのパフォーマンスを向上させるのに役立ちます。

ユーザー要件
データモデルでリレーションシップを定義・管理するには、以下の権限が必要です。

Create, edit, and publish datasets の権限が有効になっているアカウントタイプであること。

そのデータモデルの所有者であるか、Can edit のアクセス権が付与されていること。

リレーションシップを追加する
編集したいデータモデルを開きます。

リレーションシップの起点としたいデータモデル要素を選択します。

エディタパネルで Modeling タブを選択します。

Relationships のセクションで、+ （リレーションシップを追加）を選択します。

New Relationship のモーダル画面で、以下の項目を設定します。

Relationship Type (リレーションシップのタイプ):

Lookup (ルックアップ): ソーステーブルの列に、ターゲットテーブル（参照先のテーブル）の列を追加します。これは最も一般的なタイプで、例えば「商品ID」を持つ売上テーブルに、「商品名」や「カテゴリ」を持つ商品マスタテーブルを紐付けるような場合に使います。

Link (リンク): ターゲットテーブルへのドリルダウン（掘り下げ）を可能にするリンクを作成します。これにより、集計されたデータから詳細な生データへドリルダウンすることができます。

Target Element (ターゲット要素): 関連付けたいデータモデル要素（テーブル）を選択します。

Join Keys (結合キー):

Source Column (ソース列): 現在の要素（テーブル）で、結合のキーとして使用する列を選択します。

Target Column (ターゲット列): ターゲット要素（テーブル）で、結合のキーとして使用する列を選択します。

(任意) + Add another join key をクリックして、複合キーによる結合も定義できます。

Save をクリックして、リレーションシップを保存します。




列レベルのセキュリティ (Column-Level Security)
列レベルのセキュリティ（CLS）は、データモデルやデータセット内の特定の列（カラム）を、指定したユーザータイプや個々のユーザーに対して表示または非表示にする機能です。

CLSを利用することで、機密性の高いデータへのアクセスを制御できます。例えば、個人を特定できる情報（PII）や財務データなどが含まれる列を、それらの情報を閲覧する権限がないユーザーから隠すことができます。

ユーザー要件
データセットでCLSを設定するには、以下の権限が必要です。

Create, edit, and publish datasets の権限が有効になっているアカウントタイプであること。

そのデータセットの所有者であるか、Can edit のアクセス権が付与されていること。

CLSのルールを追加する
CLSは、データセット内の個々の列に対してルールを適用することで機能します。

編集したいデータセットを開き、編集モードに入ります。

CLSを適用したい列を選択します。

右側のパネルで、Permissions タブをクリックします。

Who can see this column?（この列を閲覧できるユーザー）のセクションで、ルールを追加します。

Everyone (全員): 全てのユーザーがこの列を閲覧できます。

No one (全員非表示): 管理者（Admin）を含む全てのユーザーがこの列を閲覧できなくなります。（データセットの所有者を除く）

Select user types or users... (ユーザータイプまたはユーザーを選択):

特定の Account Type（Admin, Creator, Viewerなど）を選択して、そのタイプのユーザーだけに閲覧を許可します。

個々のユーザー名やチーム名を検索して、特定のメンバーやチームにだけ閲覧を許可することもできます。

ルールを追加したら、Publish をクリックしてデータセットへの変更を保存します。

CLSの動作と注意点
非表示の挙動: CLSによって非表示にされた列は、ワークブックでの分析時に列の一覧に表示されなくなります。もし非表示の列を直接参照している計算式やビジュアライゼーションがあった場合、それらの要素はエラーを返すか、正しく表示されなくなります。

権限の継承: データセットを元に新しいデータセットやワークブックを作成した場合、CLSの設定はそれらの子要素にも引き継がれます。

行レベルのセキュリティ（RLS）との併用: CLSは、特定の行へのアクセスを制限するRLSと組み合わせて使用することで、よりきめ細やかなデータアクセス制御を実現できます。

行レベルのセキュリティ (Row-Level Security)
行レベルのセキュリティ（RLS）は、データセット内のどの行を、どのユーザーが閲覧できるかを定義するルールセットです。ユーザーがそのデータセットを元にしたワークブックを開くと、RLSが適用され、そのユーザーが閲覧を許可された行のみが表示されます。

例えば、営業担当者ごとに、自分が担当する地域の売上データのみを閲覧できるように設定することができます。

RLSの仕組み
RLSは、以下の2つの要素を使って機能します。

必須の識別子 (Required Identifier):
これは、閲覧者を識別するためのシステム変数です。例えば、[System:Email] を指定すると、現在ログインしているユーザーのメールアドレスが識別子として使用されます。

許可された値を含む列 (Column with Allowed Values):
データセット内に、識別子と比較するための値が入った列を指定します。例えば、各行に担当者のメールアドレスが記録されている [担当者メール] 列を指定します。

ユーザーがデータを閲覧すると、Sigmaはバックグラウンドで 「必須の識別子の値」と「許可された値を含む列の値」が一致する行 のみを返します。上記の例では、ログインユーザーのメールアドレスと、[担当者メール] 列の値が一致する行だけが表示されることになります。

RLSのルールを追加する
編集したいデータセットを開き、編集モードに入ります。

左側のパネルで Row-Level Security タブをクリックします。

+ Add rule をクリックして、新しいルールを作成します。

以下の項目を設定します。

Identifier (識別子):
ドロップダウンから [System:Email] や [System:UserId] などのシステム変数を選択するか、ユーザー属性を管理している場合は、[User Attribute: ...] を選択します。

Column (列):
識別子と比較する値が格納されている列をデータセットから選択します。

Publish をクリックして、データセットへの変更を保存します。

複数の値を許可する（"in" 句の使用）
1人のユーザーに複数の値（例えば、複数の担当地域）を許可したい場合があります。その場合は、[担当地域] のような列を直接比較するのではなく、ユーザーごとに許可された地域のリストを持つ別の「ルックアップテーブル」を利用します。

ユーザーのメールアドレスと、許可された地域のリストを持つルックアップテーブル（担当者別_許可地域リスト など）を作成します。

元のデータセットに、このルックアップテーブルを結合（Join）します。

RLSのルールで、[System:Email] と [担当者別_許可地域リスト].[メールアドレス] を比較するように設定します。

これにより、Sigmaはログインユーザーが閲覧を許可されている地域の行のみを動的にフィルタリングします。



階層 (Hierarchies)
階層は、関連する列を論理的な順序でグループ化し、ピボットテーブルでのドリルダウン分析を容易にするための機能です。ユーザーは定義された階層に従って、集計レベルを柔軟に切り替えることができます。

一般的な階層の例：

製品: 商品カテゴリ → ブランド → 商品名

地域: 大陸 → 国 → 都道府県 → 市区町村

時間: 年 → 四半期 → 月 → 日

階層の作成方法
ワークブックを編集モードで開きます。

階層を作成したい要素（テーブルまたはピボットテーブル）を選択します。
（注意：階層はピボットテーブルでのみ利用できます）

左側のパネルの Columns セクションで、+ アイコンをクリックし、Manage hierarchies を選択します。

Manage hierarchies のモーダル画面で、+ New hierarchy をクリックし、以下のプロパティを定義します。

Hierarchy name: 階層を識別するための名前を入力します。（例：「地域階層」）

Columns in hierarchy: Add column をクリックして、階層に含めたい列を論理的な順序（上位レベルから下位レベルへ）で追加します。

階層を定義すると、Columns セクションの該当する列に階層アイコンが表示されるようになります。

ピボットテーブルでの階層の利用
作成した階層は、ピボットテーブルの Rows または Values にドラッグ＆ドロップすることで利用できます。
階層を配置すると、ユーザーは各レベルの横にある + / - アイコンをクリックすることで、データのドリルダウンやロールアップをインタラクティブに行うことができます。

制限事項
階層機能はピボットテーブルでのみ使用できます。

階層は、作成した単一のワークブック内にのみ存在し、データセットや他のワークブックに引き継がれることはありません。

既存の階層を更新しても、その変更は、すでにその階層を使用しているピボötテーブルには自動的に適用されません。



マテリアライゼーションについて (About materialization)
マテリアライゼーションは、データセットやデータモデル内の特定の要素（テーブルなど）のコピーを、物理的なテーブルとしてお使いのデータウェアハウスに書き戻す機能です。マテリアライズされたデータは、Sigmaが管理するスキーマ内に保存されます。

この機能の最大の目的はパフォーマンスの向上です。
通常、ワークブックを開くたびに、Sigmaはデータウェアハウスに対してクエリを実行し、計算や集計を行います。データが大規模であったり、計算が複雑だったりすると、このクエリに時間がかかり、ダッシュボードの表示が遅くなる原因となります。

マテリアライゼーションを設定しておくと、Sigmaはあらかじめ計算済みの結果テーブルをデータウェアハウス内に作成しておきます。ユーザーがその要素を含むワークブックを閲覧すると、Sigmaのクエリコンパイラは、元の大規模なテーブルにクエリを実行する代わりに、この軽量な結果テーブルを自動的かつ透過的に参照します。これにより、データウェアハウスは重い再計算を行う必要がなくなり、クエリの応答時間が大幅に短縮されます。

マテリアライゼーションを利用すべきケース
マテリアライゼーションは、特に以下のような場合に大きな効果を発揮します。

複雑な結合のフラット化: 複数のテーブルをJoinしている要素をマテリアライズすることで、毎回発生する重い結合処理を回避できます。

データの粒度を下げる: 大規模な生データ（トランザクションデータなど）を日次や月次で集計したテーブルをマテリアライズしておけば、日々の分析はその軽量な集計テーブルに対して高速に実行できます。

マテリアライゼーションのスケジュール設定
マテリアライズされたテーブルは、元のデータが更新されても自動では更新されません。そのため、定期的に最新の状態に保つためのスケジュールを設定する必要があります。

編集したいデータモデルまたはワークブックを開きます。

マテリアライズしたい要素のケバブメニュー（︙）をクリックします。

Advanced options > Schedule materialization を選択します。

Materialization schedules のモーダル画面で、更新スケジュール（例：毎日午前3時）を設定します。

Save をクリックします。

注意事項
マテリアライゼーションは、データウェアハウス内に新しいテーブルを作成するため、ストレージコストが発生します。

ワークブックのフィルタ（コントロール）の値が変更された場合など、動的な操作が行われた際は、マテリアライズされたテーブルではなく、ライブデータに対してクエリが実行されます。

Snowflake接続でマテリアライゼーションを使用している場合、Sigmaは元データの更新を検知し、もし更新がなければスケジュールされたマテリアライゼーションをスキップすることで、不要なコンピューティングコストを削減します。


パラメータ (Parameters)
パラメータは、ワークブックやデータセット内で、ユーザーが動的に値を変更できるカスタムフィールドです。数式やカスタムSQL内で定数の代わりとして参照することで、インタラクティブな分析（What-if分析など）を可能にします。

例えば、「もし売上が [パラメータ] %増加したら、利益はどうなるか？」といったシナリオをシミュレーションしたい場合、固定値（例: 5%）をハードコーディングする代わりに、ユーザーが自由に変更できるパラメータ（スライダーや入力欄）を作成します。ユーザーがパラメータの値を変更すると、その値を利用している全ての計算式が即座に再計算されます。

パラメータの主な利用方法
What-if分析: 割引率、成長率、コストなどの変数をパラメータとして設定し、それらがKPIに与える影響をシミュレーションします。

ユーザー入力の活用: ユーザーが入力した値を、計算式やクエリのフィルター条件として動的に利用します。

パフォーマンス改善: データセットのパラメータを使い、ワークブックを開く前にデータを絞り込むことで、高コストなクエリの実行を抑制します。

ワークブックでのパラメータ参照
ワークブックでは、コントロール要素（スライダー、テキスト入力、ドロップダウンリストなど）がパラメータとして機能します。

ワークブックにコントロール要素（例：Number Slider）を追加します。

コントロール要素を選択し、右側のパネルの Settings タブで Control ID を確認します。（例：slider-1）

数式内で、このコントロールIDを角括弧 [] で囲んで参照します。

例:
Sum([売上]) * (1 + [slider-1])

この数式は、スライダーの値が 0.1 であれば、売上を1.1倍して将来の売上予測を計算します。ユーザーがスライダーを動かせば、計算結果もリアルタイムで変動します。

データセットでのパラメータ作成
データセット自体にパラメータを定義することもできます。これにより、データソースのレベルで値を動的に変更できます。

編集したいデータセットを開き、Worksheet タブを表示します。

左側のパネルで、PARAMETERS セクションの + アイコンをクリックします。

以下の項目を設定します。

Name: パラメータの名前（例: Growth_Rate）

Data Type: データ型（数値、テキストなど）

Default Value: デフォルト値

Suggested Values (任意): ユーザーに選択肢として提示する値のリストなどを設定できます。

作成したパラメータは、データセット内の計算列やカスタムSQLで [パラメータ名] のようにして参照できます。



URLパラメータでコントロール値を設定する
ワークブックのURLに特定のパラメータを付与することで、ワークブックを開いた際に、コントロール要素（フィルタなど）の値をあらかじめ設定しておくことができます。

これにより、同じワークブックでも、URLを変えるだけで異なる初期状態で表示させることが可能になります。例えば、特定の地域のデータに絞り込んだ状態のリンクを、その地域の担当者に共有するといった使い方ができます。

URLにクエリ文字列パラメータを追加する方法
URLにパラメータを追加する際は、決まった書式に従います。

最初のパラメータは、URLの末尾に ? を付けて追加します。

2つ目以降のパラメータは、& でつなげて追加します。

パラメータの形式は [コントロールID]=[値] となります。

例：
元のワークブックURL:
https://app.sigmacomputing.com/workbook/{workbookID}

Region というIDを持つコントロールの値を East に設定したい場合:
https://app.sigmacomputing.com/workbook/{workbookID}?Region=East

さらに、Status というIDのコントロールを Active に設定したい場合:
https://app.sigmacomputing.com/workbook/{workbookID}?Region=East&Status=Active

各コントロールタイプの設定方法
単一選択のコントロール
（テキスト入力、ドロップダウンリストなど）

単純に [コントロールID]=[値] の形式で指定します。値にスペースや特殊文字が含まれる場合は、URLエンコードが必要です。

例: ?Store%20Name=Acme%20Inc

数値範囲のコントロール
（数値範囲スライダーなど）

最小値と最大値を [コントロールID].min=[値] と [コントロールID].max=[値] の両方で指定します。

例: ?Sales.min=1000&Sales.max=5000

日付範囲のコントロール
開始日と終了日を [コントロールID].start="YYYY-MM-DD" と [コントロールID].end="YYYY-MM-DD" の形式で指定します。

例: ?Date.start="2024-01-01"&Date.end="2024-03-31"

複数選択リストのコントロール
許可したい値をカンマ , で区切って指定します。

例: ?Product%20Category=Apparel,Accessories,Shoes

埋め込みでの利用
このURLパラメータの機能は、Sigmaのワークブックを他のウェブアプリケーションに埋め込む際にも非常に強力です。ホスト側のアプリケーションから動的にURLを生成することで、ユーザーのコンテキストに応じた初期表示を出し分けることができます。
